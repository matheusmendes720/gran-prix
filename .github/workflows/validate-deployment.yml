name: Validate Deployment - ML Ops Constraint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate-deployment:
    name: Validate Deployment (NO ML Dependencies)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements_deployment.txt
      
      - name: Run ML Dependencies Check
        run: |
          python scripts/validation/check_ml_dependencies.py
      
      - name: Run ML Endpoints Check
        run: |
          python scripts/validation/check_ml_endpoints.py
      
      - name: Run ML Imports Check
        run: |
          python scripts/validation/check_ml_imports.py
      
      - name: Run Master Validation
        run: |
          python scripts/validation/validate_deployment.py
      
      - name: Build Docker Image (if Docker available)
        if: runner.os == 'Linux'
        run: |
          docker --version || echo "Docker not available - skipping Docker validation"
          if command -v docker &> /dev/null; then
            docker build -t nova-corrente-backend:deployment -f infrastructure/docker/Dockerfile.backend.deployment .
            python scripts/validation/check_docker_image.py || echo "Docker image check skipped"
          fi
      
      - name: Generate Validation Report
        if: always()
        run: |
          echo "## Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ML Ops Constraint Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ML Dependencies Check" >> $GITHUB_STEP_SUMMARY
          echo "- ML Endpoints Check" >> $GITHUB_STEP_SUMMARY
          echo "- ML Imports Check" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Image Check (if available)" >> $GITHUB_STEP_SUMMARY

