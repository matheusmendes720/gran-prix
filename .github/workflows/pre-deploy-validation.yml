name: Pre-Deployment Validation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  pre-deploy-validation:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements_deployment.txt
      
      - name: Run Full Validation Suite
        run: |
          python scripts/validation/validate_deployment.py
      
      - name: Build and Test Docker Image
        if: runner.os == 'Linux'
        run: |
          if command -v docker &> /dev/null; then
            echo "Building Docker image..."
            docker build -t nova-corrente-backend:deployment -f infrastructure/docker/Dockerfile.backend.deployment .
            
            echo "Validating Docker image..."
            python scripts/validation/check_docker_image.py
            
            echo "Checking image size..."
            IMAGE_SIZE=$(docker inspect --format='{{.Size}}' nova-corrente-backend:deployment | awk '{print $1/1024/1024}')
            echo "Image size: ${IMAGE_SIZE} MB"
            if (( $(echo "$IMAGE_SIZE > 600" | bc -l) )); then
              echo "❌ Image size exceeds 600 MB limit"
              exit 1
            fi
          fi
      
      - name: Generate Deployment Readiness Report
        if: always()
        run: |
          echo "# Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ ML Ops Constraint Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docker Image Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Image Size Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Checklist:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] All validations passed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Docker images built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Image sizes within limits (< 600 MB)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No ML dependencies detected" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No ML endpoints detected" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Environment variables configured" >> $GITHUB_STEP_SUMMARY

